<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBSç‚¹æ­Œå¹³å°</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8B5CF6',
            secondary: '#EC4899',
            accent: '#06B6D4',
            dark: '#0F172A',
            'dark-light': '#1E293B',
            'neon-pink': '#FF00FF',
            'neon-blue': '#00FFFF',
            'neon-purple': '#9D00FF'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 3s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 5px theme("colors.neon-purple"), 0 0 10px theme("colors.neon-purple")' },
              '100%': { boxShadow: '0 0 10px theme("colors.neon-purple"), 0 0 20px theme("colors.neon-purple"), 0 0 30px theme("colors.neon-purple")' },
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow-neon {
        text-shadow: 0 0 5px theme('colors.neon-purple'), 0 0 10px theme('colors.neon-purple');
      }
      .text-shadow-pink {
        text-shadow: 0 0 5px theme('colors.neon-pink'), 0 0 10px theme('colors.neon-pink');
      }
      .text-shadow-blue {
        text-shadow: 0 0 5px theme('colors.neon-blue'), 0 0 10px theme('colors.neon-blue');
      }
      .bg-glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .border-glow {
        box-shadow: 0 0 5px theme('colors.neon-purple'), 0 0 10px theme('colors.neon-purple');
      }
      .border-glow-pink {
        box-shadow: 0 0 5px theme('colors.neon-pink'), 0 0 10px theme('colors.neon-pink');
      }
      .border-glow-blue {
        box-shadow: 0 0 5px theme('colors.neon-blue'), 0 0 10px theme('colors.neon-blue');
      }
      .scrollbar-hidden::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hidden {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .danmaku {
        position: absolute;
        white-space: nowrap;
        animation: danmaku-move 8s linear;
      }
      @keyframes danmaku-move {
        from { transform: translateX(100%); }
        to { transform: translateX(-100%); }
      }
    }
  </style>
</head>
<body class="bg-dark text-white min-h-screen font-sans">
  <!-- èƒŒæ™¯å›¾ -->
  <div class="fixed inset-0 z-0 opacity-20">
    <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/97be7216856245919f3e2bdd0ba89173~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=20260109020234E71D524EDFDE922968A0&rrcfp=f06b921b&x-expires=1770487384&x-signature=2IU1%2FWsKVmsax7ydA%2B0DSt7W9xM%3D" 
         alt="éŸ³ä¹èƒŒæ™¯" 
         class="w-full h-full object-cover">
  </div>

  <!-- å¯¼èˆªæ  -->
  <nav class="bg-glass border-b border-gray-700 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <i class="fa fa-music text-neon-purple text-2xl"></i>
          <h1 class="text-xl font-bold text-white">
            <span class="text-neon-purple">OBS</span>
            <span class="text-neon-pink">ç‚¹æ­Œ</span>
            <span class="text-neon-blue">å¹³å°</span>
          </h1>
        </div>
        
        <div class="flex space-x-4">
          <button id="viewerBtn" class="px-4 py-2 rounded-md bg-primary text-white hover:bg-opacity-80 transition-all border-glow">
            è§‚ä¼—ç‚¹æ­Œ
          </button>
          <button id="hostBtn" class="px-4 py-2 rounded-md bg-dark-light text-white hover:bg-gray-700 transition-all">
            ä¸»æ’­ç®¡ç†
          </button>
          <a href="./obs.html" target="_blank" class="px-4 py-2 rounded-md bg-accent text-white hover:bg-opacity-80 transition-all">
            OBSè§†å›¾
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="container mx-auto px-4 py-8 relative z-10">
    <!-- è§‚ä¼—ç‚¹æ­Œè§†å›¾ -->
    <div id="viewerView" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- å·¦ä¾§ï¼šç‚¹æ­ŒåŒº -->
      <div class="lg:col-span-2 space-y-6">
        <!-- æœç´¢æ¡† -->
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-pink text-shadow-pink">æ­Œæ›²æœç´¢</h2>
          <div class="flex space-x-2">
            <input type="text" id="songSearch" placeholder="è¾“å…¥æ­Œæ›²åæˆ–æ­Œæ‰‹..." 
                  class="flex-1 bg-dark-light border border-gray-700 rounded-md px-4 py-2 focus:outline-none focus:border-neon-purple">
            <button id="searchBtn" class="bg-primary hover:bg-opacity-80 px-4 py-2 rounded-md transition-all">
              <i class="fa fa-search"></i> æœç´¢
            </button>
          </div>
          
          <!-- æœç´¢ç»“æœ -->
          <div id="searchResults" class="mt-4 max-h-60 overflow-y-auto scrollbar-hidden hidden">
            <div class="space-y-2">
              <!-- æœç´¢ç»“æœå°†åŠ¨æ€æ’å…¥ -->
            </div>
          </div>
        </div>
        
        <!-- ç‚¹æ­Œè¡¨å• -->
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-blue text-shadow-blue">ç‚¹æ­Œ</h2>
          <form id="requestForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">æ­Œæ›²å</label>
              <input type="text" id="songTitle" required 
                    class="w-full bg-dark-light border border-gray-700 rounded-md px-4 py-2 focus:outline-none focus:border-neon-blue">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">æ­Œæ‰‹</label>
              <input type="text" id="songArtist" required 
                    class="w-full bg-dark-light border border-gray-700 rounded-md px-4 py-2 focus:outline-none focus:border-neon-blue">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">ä½ çš„æ˜µç§°</label>
              <input type="text" id="userName" required 
                    class="w-full bg-dark-light border border-gray-700 rounded-md px-4 py-2 focus:outline-none focus:border-neon-blue">
            </div>
            <button type="submit" class="w-full bg-secondary hover:bg-opacity-80 py-2 rounded-md transition-all text-lg font-semibold animate-pulse-slow">
              <i class="fa fa-paper-plane mr-2"></i> æäº¤ç‚¹æ­Œ
            </button>
          </form>
        </div>
        
        <!-- å¼¹å¹•ç‚¹æ­Œ -->
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-purple text-shadow-neon">å¼¹å¹•ç‚¹æ­Œ</h2>
          <div class="mb-4">
            <input type="text" id="danmakuInput" placeholder="å‘é€å¼¹å¹•ï¼Œæ ¼å¼ï¼šç‚¹æ­Œ æ­Œæ›²å - æ­Œæ‰‹" 
                  class="w-full bg-dark-light border border-gray-700 rounded-md px-4 py-2 focus:outline-none focus:border-neon-purple">
          </div>
          <button id="sendDanmakuBtn" class="w-full bg-neon-purple bg-opacity-20 hover:bg-opacity-30 py-2 rounded-md transition-all border border-neon-purple">
            <i class="fa fa-comment mr-2"></i> å‘é€å¼¹å¹•
          </button>
          
          <!-- å¼¹å¹•å±•ç¤ºåŒº -->
          <div id="danmakuContainer" class="mt-4 h-40 relative overflow-hidden bg-dark bg-opacity-50 rounded-md">
            <!-- å¼¹å¹•å°†åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§ï¼šçƒ­é—¨æ­Œæ›² -->
      <div class="space-y-6">
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-pink text-shadow-pink">çƒ­é—¨æ­Œæ›²</h2>
          <div class="space-y-3">
            <div id="hotSongsList" class="space-y-2">
              <!-- çƒ­é—¨æ­Œæ›²å°†åŠ¨æ€æ’å…¥ -->
            </div>
          </div>
        </div>
        
        <!-- ç‚¹æ­Œç»Ÿè®¡ -->
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-blue text-shadow-blue">ç‚¹æ­Œç»Ÿè®¡</h2>
          <canvas id="statsChart" height="200"></canvas>
        </div>
        
        <!-- æœ€è¿‘ç‚¹æ­Œ -->
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-purple text-shadow-neon">æœ€è¿‘ç‚¹æ­Œ</h2>
          <div id="recentRequests" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hidden">
            <!-- æœ€è¿‘ç‚¹æ­Œå°†åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- ä¸»æ’­ç®¡ç†è§†å›¾ -->
    <div id="hostView" class="hidden space-y-8">
      <!-- æ­Œæ›²ç®¡ç† -->
      <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-neon-pink text-shadow-pink">æ­Œæ›²ç®¡ç†</h2>
          <div class="flex space-x-2">
            <button id="refreshListBtn" class="px-3 py-1 rounded-md bg-accent text-white hover:bg-opacity-80 transition-all">
              <i class="fa fa-refresh mr-1"></i> åˆ·æ–°
            </button>
            <button id="clearCompletedBtn" class="px-3 py-1 rounded-md bg-red-500 text-white hover:bg-opacity-80 transition-all">
              <i class="fa fa-trash mr-1"></i> æ¸…é™¤å·²å®Œæˆ
            </button>
          </div>
        </div>
        
        <!-- å¾…æ’­æ”¾åˆ—è¡¨ -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-neon-blue text-shadow-blue">å¾…æ’­æ”¾ (<span id="pendingCount">0</span>)</h3>
          <div id="pendingList" class="space-y-2 max-h-80 overflow-y-auto scrollbar-hidden">
            <!-- å¾…æ’­æ”¾æ­Œæ›²å°†åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
        
        <!-- æ’­æ”¾ä¸­ -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3 text-neon-purple text-shadow-neon">æ’­æ”¾ä¸­</h3>
          <div id="playingList" class="space-y-2">
            <!-- æ’­æ”¾ä¸­æ­Œæ›²å°†åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
        
        <!-- å·²å®Œæˆ -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-400">å·²å®Œæˆ (<span id="completedCount">0</span>)</h3>
          <div id="completedList" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hidden">
            <!-- å·²å®Œæˆæ­Œæ›²å°†åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
      </div>
      
      <!-- æ•°æ®ç»Ÿè®¡ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-blue text-shadow-blue">ç‚¹æ­Œç»Ÿè®¡</h2>
          <canvas id="hostStatsChart" height="250"></canvas>
        </div>
        
        <div class="bg-glass rounded-lg p-6 border border-gray-700 shadow-lg">
          <h2 class="text-xl font-bold mb-4 text-neon-pink text-shadow-pink">çƒ­é—¨æ­Œæ‰‹</h2>
          <canvas id="artistChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </main>

  <!-- ç‚¹æ­ŒæˆåŠŸæç¤º -->
  <div id="successToast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 z-50">
    <div class="flex items-center">
      <i class="fa fa-check-circle text-2xl mr-2"></i>
      <span>ç‚¹æ­ŒæˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„è¯·æ±‚ ğŸµ</span>
    </div>
  </div>

  <!-- å¼¹å¹•ç‚¹æ­Œæç¤º -->
  <div id="danmakuToast" class="fixed bottom-4 right-4 bg-neon-purple bg-opacity-80 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 z-50">
    <div class="flex items-center">
      <i class="fa fa-comment text-2xl mr-2"></i>
      <span>å¼¹å¹•å‘é€æˆåŠŸï¼</span>
    </div>
  </div>

  <script>
    // æ¨¡æ‹Ÿæ­Œæ›²æ•°æ®åº“
    const songDatabase = [
      { title: "èµ·é£äº†", artist: "ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸" },
      { title: "æµ·é˜”å¤©ç©º", artist: "Beyond" },
      { title: "æˆéƒ½", artist: "èµµé›·" },
      { title: "å…‰å¹´ä¹‹å¤–", artist: "é‚“ç´«æ£‹" },
      { title: "è¿½å…‰è€…", artist: "å²‘å®å„¿" },
      { title: "å°å¹¸è¿", artist: "ç”°é¦¥ç”„" },
      { title: "Shape of You", artist: "Ed Sheeran" },
      { title: "Let it Go", artist: "Idina Menzel" },
      { title: "å¤œæ›²", artist: "å‘¨æ°ä¼¦" },
      { title: "å‘Šç™½æ°”çƒ", artist: "å‘¨æ°ä¼¦" },
      { title: "æ¼”å‘˜", artist: "è–›ä¹‹è°¦" },
      { title: "å€’å¸¦", artist: "å‘¨æ°ä¼¦" },
      { title: "æ™´å¤©", artist: "å‘¨æ°ä¼¦" },
      { title: "åæ¥", artist: "åˆ˜è‹¥è‹±" },
      { title: "é‚£äº›å¹´", artist: "èƒ¡å¤" },
      { title: "æˆ‘ä»¬çš„çˆ±", artist: "FIR" },
      { title: "æ³¡æ²«", artist: "é‚“ç´«æ£‹" },
      { title: "æ±Ÿå—", artist: "æ—ä¿Šæ°" },
      { title: "å¯æƒœæ²¡å¦‚æœ", artist: "æ—ä¿Šæ°" },
      { title: "æ›¹æ“", artist: "æ—ä¿Šæ°" }
    ];

    // åˆå§‹åŒ–æ•°æ®
    let songRequests = JSON.parse(localStorage.getItem('songRequests')) || [];
    let danmakuList = JSON.parse(localStorage.getItem('danmakuList')) || [];
    let statsData = JSON.parse(localStorage.getItem('statsData')) || {
      songStats: [],
      dailyRequests: {}
    };

    // DOMå…ƒç´ 
    const viewerBtn = document.getElementById('viewerBtn');
    const hostBtn = document.getElementById('hostBtn');
    const viewerView = document.getElementById('viewerView');
    const hostView = document.getElementById('hostView');
    const songSearch = document.getElementById('songSearch');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    const requestForm = document.getElementById('requestForm');
    const danmakuInput = document.getElementById('danmakuInput');
    const sendDanmakuBtn = document.getElementById('sendDanmakuBtn');
    const danmakuContainer = document.getElementById('danmakuContainer');
    const hotSongsList = document.getElementById('hotSongsList');
    const recentRequests = document.getElementById('recentRequests');
    const refreshListBtn = document.getElementById('refreshListBtn');
    const clearCompletedBtn = document.getElementById('clearCompletedBtn');
    const pendingList = document.getElementById('pendingList');
    const playingList = document.getElementById('playingList');
    const completedList = document.getElementById('completedList');
    const pendingCount = document.getElementById('pendingCount');
    const completedCount = document.getElementById('completedCount');
    const successToast = document.getElementById('successToast');
    const danmakuToast = document.getElementById('danmakuToast');

    // è§†å›¾åˆ‡æ¢
    viewerBtn.addEventListener('click', () => {
      viewerView.classList.remove('hidden');
      hostView.classList.add('hidden');
      viewerBtn.classList.add('bg-primary', 'border-glow');
      viewerBtn.classList.remove('bg-dark-light');
      hostBtn.classList.add('bg-dark-light');
      hostBtn.classList.remove('bg-primary', 'border-glow');
    });

    hostBtn.addEventListener('click', () => {
      viewerView.classList.add('hidden');
      hostView.classList.remove('hidden');
      hostBtn.classList.add('bg-primary', 'border-glow');
      hostBtn.classList.remove('bg-dark-light');
      viewerBtn.classList.add('bg-dark-light');
      viewerBtn.classList.remove('bg-primary', 'border-glow');
      updateHostView();
      initHostCharts();
    });

    // æœç´¢åŠŸèƒ½
    searchBtn.addEventListener('click', performSearch);
    songSearch.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    function performSearch() {
      const query = songSearch.value.toLowerCase().trim();
      if (!query) {
        searchResults.classList.add('hidden');
        return;
      }

      const results = songDatabase.filter(song => 
        song.title.toLowerCase().includes(query) || 
        song.artist.toLowerCase().includes(query)
      );

      if (results.length > 0) {
        const resultsHTML = results.map(song => `
          <div class="p-2 hover:bg-dark-light rounded-md cursor-pointer transition-all flex justify-between items-center" 
               onclick="selectSong('${song.title}', '${song.artist}')">
            <div>
              <div class="font-medium">${song.title}</div>
              <div class="text-sm text-gray-400">${song.artist}</div>
            </div>
            <button class="text-neon-purple hover:text-neon-pink transition-colors">
              <i class="fa fa-plus-circle"></i>
            </button>
          </div>
        `).join('');
        
        searchResults.querySelector('.space-y-2').innerHTML = resultsHTML;
        searchResults.classList.remove('hidden');
      } else {
        searchResults.querySelector('.space-y-2').innerHTML = `
          <div class="p-2 text-center text-gray-400">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>
        `;
        searchResults.classList.remove('hidden');
      }
    }

    // é€‰æ‹©æ­Œæ›²
    window.selectSong = function(title, artist) {
      document.getElementById('songTitle').value = title;
      document.getElementById('songArtist').value = artist;
      searchResults.classList.add('hidden');
      songSearch.value = '';
      
      // æ»šåŠ¨åˆ°ç‚¹æ­Œè¡¨å•
      document.getElementById('requestForm').scrollIntoView({ behavior: 'smooth' });
    };

    // ç‚¹æ­Œè¡¨å•æäº¤
    requestForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('songTitle').value.trim();
      const artist = document.getElementById('songArtist').value.trim();
      const userName = document.getElementById('userName').value.trim();
      
      if (title && artist && userName) {
        addSongRequest(title, artist, userName, 'form');
        requestForm.reset();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        successToast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => {
          successToast.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
      }
    });

    // æ·»åŠ ç‚¹æ­Œè¯·æ±‚
    function addSongRequest(title, artist, userName, requestType) {
      const newRequest = {
        id: Date.now().toString(),
        title,
        artist,
        requestedBy: userName,
        requestTime: new Date(),
        status: 'pending',
        requestType
      };
      
      songRequests.push(newRequest);
      updateLocalStorage();
      updateRecentRequests();
      updateHotSongs();
      updateStats();
    }

    // å¼¹å¹•åŠŸèƒ½
    sendDanmakuBtn.addEventListener('click', sendDanmaku);
    danmakuInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendDanmaku();
      }
    });

    function sendDanmaku() {
      const content = danmakuInput.value.trim();
      if (!content) return;
      
      const userName = generateRandomName();
      const newDanmaku = {
        id: Date.now().toString(),
        user: userName,
        content,
        timestamp: new Date(),
        isSongRequest: false,
        parsedSong: null
      };
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºç‚¹æ­Œå¼¹å¹•
      const songRequestPattern = /ç‚¹æ­Œ\s+(.+?)\s*[-â€“â€”]\s*(.+)/;
      const match = content.match(songRequestPattern);
      
      if (match) {
        newDanmaku.isSongRequest = true;
        newDanmaku.parsedSong = {
          title: match[1].trim(),
          artist: match[2].trim()
        };
        
        // è‡ªåŠ¨æ·»åŠ åˆ°ç‚¹æ­Œåˆ—è¡¨
        addSongRequest(match[1].trim(), match[2].trim(), userName, 'danmaku');
      }
      
      danmakuList.push(newDanmaku);
      if (danmakuList.length > 100) {
        danmakuList.shift(); // ä¿æŒå¼¹å¹•æ•°é‡åœ¨åˆç†èŒƒå›´
      }
      
      updateLocalStorage();
      displayDanmaku(newDanmaku);
      danmakuInput.value = '';
      
      // æ˜¾ç¤ºå¼¹å¹•å‘é€æˆåŠŸæç¤º
      danmakuToast.classList.remove('translate-y-20', 'opacity-0');
      setTimeout(() => {
        danmakuToast.classList.add('translate-y-20', 'opacity-0');
      }, 2000);
    }

    // æ˜¾ç¤ºå¼¹å¹•
    function displayDanmaku(danmaku) {
      const danmakuEl = document.createElement('div');
      danmakuEl.className = 'danmaku';
      danmakuEl.style.top = `${Math.random() * 80}%`;
      danmakuEl.style.color = danmaku.isSongRequest ? '#FF00FF' : '#FFFFFF';
      danmakuEl.style.fontWeight = danmaku.isSongRequest ? 'bold' : 'normal';
      danmakuEl.innerHTML = `<span class="text-neon-blue">${danmaku.user}:</span> ${danmaku.content}`;
      
      danmakuContainer.appendChild(danmakuEl);
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤
      setTimeout(() => {
        danmakuEl.remove();
      }, 8000);
    }

    // ç”Ÿæˆéšæœºç”¨æˆ·å
    function generateRandomName() {
      const adjectives = ['å¿«ä¹çš„', 'å¯çˆ±çš„', 'é…·é…·çš„', 'ç¥ç§˜çš„', 'ä¼˜é›…çš„', 'å‹‡æ•¢çš„', 'èªæ˜çš„', 'æ¸©æŸ”çš„'];
      const nouns = ['å°çŒ«', 'å°ç‹—', 'å…”å­', 'ç†ŠçŒ«', 'ç‹ç‹¸', 'ä¼é¹…', 'æµ·è±š', 'æ˜Ÿæ˜Ÿ'];
      const randomNum = Math.floor(Math.random() * 1000);
      
      const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const noun = nouns[Math.floor(Math.random() * nouns.length)];
      
      return `${adj}${noun}${randomNum}`;
    }

    // æ›´æ–°æœ€è¿‘ç‚¹æ­Œ
    function updateRecentRequests() {
      const recent = songRequests
        .sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime))
        .slice(0, 10);
      
      if (recent.length > 0) {
        const recentHTML = recent.map(req => `
          <div class="p-2 hover:bg-dark-light rounded-md transition-all">
            <div class="font-medium">${req.title}</div>
            <div class="text-sm text-gray-400">${req.artist} - ${req.requestedBy}</div>
            <div class="text-xs text-gray-500">${formatTime(req.requestTime)}</div>
          </div>
        `).join('');
        
        recentRequests.innerHTML = recentHTML;
      } else {
        recentRequests.innerHTML = `<div class="p-2 text-center text-gray-400">æš‚æ— ç‚¹æ­Œè®°å½•</div>`;
      }
    }

    // æ›´æ–°çƒ­é—¨æ­Œæ›²
    function updateHotSongs() {
      // ç»Ÿè®¡æ­Œæ›²è¯·æ±‚æ¬¡æ•°
      const songCounts = {};
      songRequests.forEach(req => {
        const key = `${req.title}-${req.artist}`;
        songCounts[key] = (songCounts[key] || 0) + 1;
      });
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
      const hotSongs = Object.entries(songCounts)
        .map(([key, count]) => {
          const [title, artist] = key.split('-');
          return { title, artist, count };
        })
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
      
      if (hotSongs.length > 0) {
        const hotSongsHTML = hotSongs.map((song, index) => `
          <div class="p-2 hover:bg-dark-light rounded-md transition-all flex justify-between items-center cursor-pointer"
               onclick="selectSong('${song.title}', '${song.artist}')">
            <div class="flex items-center">
              <span class="w-6 h-6 rounded-full bg-neon-purple flex items-center justify-center mr-2 text-sm">
                ${index + 1}
              </span>
              <div>
                <div class="font-medium">${song.title}</div>
                <div class="text-sm text-gray-400">${song.artist}</div>
              </div>
            </div>
            <span class="bg-dark-light px-2 py-1 rounded-full text-xs">
              <i class="fa fa-fire text-neon-pink mr-1"></i> ${song.count}
            </span>
          </div>
        `).join('');
        
        hotSongsList.innerHTML = hotSongsHTML;
      } else {
        hotSongsList.innerHTML = `<div class="p-2 text-center text-gray-400">æš‚æ— çƒ­é—¨æ­Œæ›²</div>`;
      }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      // æ›´æ–°æ¯æ—¥è¯·æ±‚æ•°
      const today = new Date().toISOString().split('T')[0];
      statsData.dailyRequests[today] = (statsData.dailyRequests[today] || 0) + 1;
      
      // æ›´æ–°æ­Œæ›²ç»Ÿè®¡
      const lastRequest = songRequests[songRequests.length - 1];
      if (lastRequest) {
        const existingSong = statsData.songStats.find(
          s => s.title === lastRequest.title && s.artist === lastRequest.artist
        );
        
        if (existingSong) {
          existingSong.requestCount++;
        } else {
          statsData.songStats.push({
            title: lastRequest.title,
            artist: lastRequest.artist,
            requestCount: 1
          });
        }
        
        // æŒ‰è¯·æ±‚æ¬¡æ•°æ’åº
        statsData.songStats.sort((a, b) => b.requestCount - a.requestCount);
      }
      
      updateLocalStorage();
    }

    // æ›´æ–°æœ¬åœ°å­˜å‚¨
    function updateLocalStorage() {
      localStorage.setItem('songRequests', JSON.stringify(songRequests));
      localStorage.setItem('danmakuList', JSON.stringify(danmakuList));
      localStorage.setItem('statsData', JSON.stringify(statsData));
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timeStr) {
      const date = new Date(timeStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // å°äº1åˆ†é’Ÿ
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // å°äº1å°æ—¶
        return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
      } else if (diff < 86400000) { // å°äº1å¤©
        return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
      } else {
        return date.toLocaleDateString();
      }
    }

    // æ›´æ–°ä¸»æ’­è§†å›¾
    function updateHostView() {
      const pending = songRequests.filter(req => req.status === 'pending');
      const playing = songRequests.filter(req => req.status === 'playing');
      const completed = songRequests.filter(req => req.status === 'completed');
      
      pendingCount.textContent = pending.length;
      completedCount.textContent = completed.length;
      
      // æ›´æ–°å¾…æ’­æ”¾åˆ—è¡¨
      if (pending.length > 0) {
        pendingList.innerHTML = pending.map(req => `
          <div class="p-3 bg-dark-light rounded-md border border-gray-700 hover:border-neon-blue transition-all flex justify-between items-center"
               draggable="true" data-id="${req.id}">
            <div>
              <div class="font-medium">${req.title}</div>
              <div class="text-sm text-gray-400">${req.artist} - ${req.requestedBy}</div>
              <div class="text-xs text-gray-500">${formatTime(req.requestTime)} ${req.requestType === 'danmaku' ? '(å¼¹å¹•ç‚¹æ­Œ)' : ''}</div>
            </div>
            <div class="flex space-x-2">
              <button class="text-neon-purple hover:text-neon-pink transition-colors" onclick="startPlaying('${req.id}')">
                <i class="fa fa-play-circle text-xl"></i>
              </button>
              <button class="text-gray-400 hover:text-red-500 transition-colors" onclick="removeRequest('${req.id}')">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
        
        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        addDragAndDrop(pendingList);
      } else {
        pendingList.innerHTML = `<div class="p-3 text-center text-gray-400">æš‚æ— å¾…æ’­æ”¾æ­Œæ›²</div>`;
      }
      
      // æ›´æ–°æ’­æ”¾ä¸­åˆ—è¡¨
      if (playing.length > 0) {
        playingList.innerHTML = playing.map(req => `
          <div class="p-3 bg-dark-light rounded-md border border-neon-purple border-glow transition-all flex justify-between items-center">
            <div>
              <div class="font-medium text-neon-purple">${req.title}</div>
              <div class="text-sm text-gray-400">${req.artist} - ${req.requestedBy}</div>
              <div class="text-xs text-gray-500">${formatTime(req.requestTime)}</div>
            </div>
            <div class="flex space-x-2">
              <button class="text-neon-blue hover:text-neon-pink transition-colors" onclick="completeSong('${req.id}')">
                <i class="fa fa-check-circle text-xl"></i>
              </button>
            </div>
          </div>
        `).join('');
      } else {
        playingList.innerHTML = `<div class="p-3 text-center text-gray-400">å½“å‰æ²¡æœ‰æ’­æ”¾ä¸­çš„æ­Œæ›²</div>`;
      }
      
      // æ›´æ–°å·²å®Œæˆåˆ—è¡¨
      if (completed.length > 0) {
        completedList.innerHTML = completed
          .sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime))
          .map(req => `
            <div class="p-3 bg-dark-light bg-opacity-50 rounded-md border border-gray-700 flex justify-between items-center">
              <div>
                <div class="font-medium text-gray-400">${req.title}</div>
                <div class="text-sm text-gray-500">${req.artist} - ${req.requestedBy}</div>
                <div class="text-xs text-gray-600">${formatTime(req.requestTime)}</div>
              </div>
              <button class="text-gray-500 hover:text-red-500 transition-colors" onclick="removeRequest('${req.id}')">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          `).join('');
      } else {
        completedList.innerHTML = `<div class="p-3 text-center text-gray-500">æš‚æ— å·²å®Œæˆæ­Œæ›²</div>`;
      }
    }

    // æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½
    function addDragAndDrop(container) {
      const items = container.querySelectorAll('[draggable="true"]');
      let draggedItem = null;
      
      items.forEach(item => {
        item.addEventListener('dragstart', function() {
          draggedItem = this;
          setTimeout(() => this.style.opacity = '0.5', 0);
        });
        
        item.addEventListener('dragend', function() {
          this.style.opacity = '1';
          draggedItem = null;
          
          // æ›´æ–°é¡ºåº
          const newOrder = Array.from(container.querySelectorAll('[draggable="true"]'))
            .map(item => item.dataset.id);
          
          // é‡æ–°æ’åºè¯·æ±‚åˆ—è¡¨
          const reorderedRequests = [];
          newOrder.forEach(id => {
            const req = songRequests.find(r => r.id === id);
            if (req) reorderedRequests.push(req);
          });
          
          // ä¿ç•™å…¶ä»–çŠ¶æ€çš„è¯·æ±‚
          const otherRequests = songRequests.filter(req => req.status !== 'pending');
          
          // åˆå¹¶å¹¶æ›´æ–°
          songRequests = [...reorderedRequests, ...otherRequests];
          updateLocalStorage();
        });
        
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
        });
        
        item.addEventListener('dragenter', function(e) {
          e.preventDefault();
          if (this !== draggedItem) {
            this.classList.add('border-neon-pink');
          }
        });
        
        item.addEventListener('dragleave', function() {
          this.classList.remove('border-neon-pink');
        });
        
        item.addEventListener('drop', function() {
          this.classList.remove('border-neon-pink');
          
          if (this !== draggedItem) {
            const container = this.parentNode;
            const draggedIndex = Array.from(container.children).indexOf(draggedItem);
            const dropIndex = Array.from(container.children).indexOf(this);
            
            if (draggedIndex < dropIndex) {
              container.insertBefore(draggedItem, this.nextSibling);
            } else {
              container.insertBefore(draggedItem, this);
            }
          }
        });
      });
    }

    // å¼€å§‹æ’­æ”¾æ­Œæ›²
    window.startPlaying = function(id) {
      // å…ˆå°†æ‰€æœ‰æ­Œæ›²è®¾ç½®ä¸ºéæ’­æ”¾ä¸­çŠ¶æ€
      songRequests.forEach(req => {
        if (req.status === 'playing') {
          req.status = 'completed';
        }
      });
      
      // è®¾ç½®é€‰ä¸­çš„æ­Œæ›²ä¸ºæ’­æ”¾ä¸­
      const reqIndex = songRequests.findIndex(req => req.id === id);
      if (reqIndex !== -1) {
        songRequests[reqIndex].status = 'playing';
        updateLocalStorage();
        updateHostView();
      }
    };

    // å®Œæˆæ­Œæ›²
    window.completeSong = function(id) {
      const reqIndex = songRequests.findIndex(req => req.id === id);
      if (reqIndex !== -1) {
        songRequests[reqIndex].status = 'completed';
        updateLocalStorage();
        updateHostView();
      }
    };

    // ç§»é™¤è¯·æ±‚
    window.removeRequest = function(id) {
      songRequests = songRequests.filter(req => req.id !== id);
      updateLocalStorage();
      updateHostView();
      updateRecentRequests();
      updateHotSongs();
    };

    // åˆ·æ–°åˆ—è¡¨
    refreshListBtn.addEventListener('click', updateHostView);

    // æ¸…é™¤å·²å®Œæˆ
    clearCompletedBtn.addEventListener('click', () => {
      songRequests = songRequests.filter(req => req.status !== 'completed');
      updateLocalStorage();
      updateHostView();
    });

    // åˆå§‹åŒ–å›¾è¡¨
    function initStatsChart() {
      const ctx = document.getElementById('statsChart').getContext('2d');
      
      // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
      const dates = [];
      const counts = [];
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        dates.push(dateStr.substring(5)); // åªæ˜¾ç¤ºæœˆ-æ—¥
        
        counts.push(statsData.dailyRequests[dateStr] || 0);
      }
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'ç‚¹æ­Œæ•°é‡',
            data: counts,
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.2)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // åˆå§‹åŒ–ä¸»æ’­è§†å›¾å›¾è¡¨
    function initHostCharts() {
      // ç‚¹æ­Œç»Ÿè®¡å›¾è¡¨
      const statsCtx = document.getElementById('hostStatsChart').getContext('2d');
      
      // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
      const dates = [];
      const counts = [];
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        dates.push(dateStr.substring(5)); // åªæ˜¾ç¤ºæœˆ-æ—¥
        
        counts.push(statsData.dailyRequests[dateStr] || 0);
      }
      
      new Chart(statsCtx, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [{
            label: 'ç‚¹æ­Œæ•°é‡',
            data: counts,
            backgroundColor: [
              'rgba(236, 72, 153, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(6, 182, 212, 0.7)',
              'rgba(236, 72, 153, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(6, 182, 212, 0.7)',
              'rgba(236, 72, 153, 0.7)'
            ],
            borderColor: [
              'rgb(236, 72, 153)',
              'rgb(139, 92, 246)',
              'rgb(6, 182, 212)',
              'rgb(236, 72, 153)',
              'rgb(139, 92, 246)',
              'rgb(6, 182, 212)',
              'rgb(236, 72, 153)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)'
              }
            }
          }
        }
      });
      
      // æ­Œæ‰‹ç»Ÿè®¡å›¾è¡¨
      const artistCtx = document.getElementById('artistChart').getContext('2d');
      
      // ç»Ÿè®¡æ­Œæ‰‹å‡ºç°æ¬¡æ•°
      const artistCounts = {};
      songRequests.forEach(req => {
        artistCounts[req.artist] = (artistCounts[req.artist] || 0) + 1;
      });
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
      const artistData = Object.entries(artistCounts)
        .map(([artist, count]) => ({ artist, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 8);
      
      new Chart(artistCtx, {
        type: 'doughnut',
        data: {
          labels: artistData.map(a => a.artist),
          datasets: [{
            data: artistData.map(a => a.count),
            backgroundColor: [
              'rgba(236, 72, 153, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(6, 182, 212, 0.7)',
              'rgba(52, 211, 153, 0.7)',
              'rgba(249, 115, 22, 0.7)',
              'rgba(234, 179, 8, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(139, 92, 246, 0.7)'
            ],
            borderColor: [
              'rgb(236, 72, 153)',
              'rgb(139, 92, 246)',
              'rgb(6, 182, 212)',
              'rgb(52, 211, 153)',
              'rgb(249, 115, 22)',
              'rgb(234, 179, 8)',
              'rgb(16, 185, 129)',
              'rgb(139, 92, 246)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(255, 255, 255, 0.7)',
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    // åˆå§‹åŒ–
    function init() {
      updateRecentRequests();
      updateHotSongs();
      initStatsChart();
      
      // æ¨¡æ‹Ÿä¸€äº›åˆå§‹æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ï¼‰
      if (songRequests.length === 0) {
        const mockRequests = [
          {
            id: '1',
            title: 'èµ·é£äº†',
            artist: 'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸',
            requestedBy: 'éŸ³ä¹å°è¾¾äºº',
            requestTime: new Date(Date.now() - 3600000).toISOString(),
            status: 'completed',
            requestType: 'form'
          },
          {
            id: '2',
            title: 'æµ·é˜”å¤©ç©º',
            artist: 'Beyond',
            requestedBy: 'æ‘‡æ»šé’å¹´',
            requestTime: new Date(Date.now() - 7200000).toISOString(),
            status: 'pending',
            requestType: 'form'
          },
          {
            id: '3',
            title: 'æˆéƒ½',
            artist: 'èµµé›·',
            requestedBy: 'æµæµªè¯—äºº',
            requestTime: new Date(Date.now() - 10800000).toISOString(),
            status: 'pending',
            requestType: 'danmaku'
          }
        ];
        
        songRequests = mockRequests;
        updateLocalStorage();
        updateRecentRequests();
        updateHotSongs();
        updateStats();
      }
      
      // æ¨¡æ‹Ÿå¼¹å¹•
      setInterval(() => {
        const randomComments = [
          'ä¸»æ’­å”±å¾—çœŸå¥½å¬ï¼',
          'è¿™é¦–æ­Œå¤ªç»å…¸äº†',
          'æ±‚å”±å‘¨æ°ä¼¦çš„æ­Œ',
          'ä¸»æ’­å¥½å‰å®³ï¼',
          'è¿™ä¸ªæ—‹å¾‹å¤ªç¾äº†',
          'ç‚¹æ­Œ æ™´å¤© - å‘¨æ°ä¼¦',
          'ç‚¹æ­Œ å‘Šç™½æ°”çƒ - å‘¨æ°ä¼¦',
          'ä¸»æ’­å£°éŸ³å¥½å¥½å¬',
          'è¿™é¦–æ­Œæˆ‘ä¹Ÿä¼šå”±',
          'å¤ªå¥½å¬äº†å§ï¼'
        ];
        
        const randomComment = randomComments[Math.floor(Math.random() * randomComments.length)];
        const mockDanmaku = {
          id: Date.now().toString(),
          user: generateRandomName(),
          content: randomComment,
          timestamp: new Date(),
          isSongRequest: randomComment.startsWith('ç‚¹æ­Œ'),
          parsedSong: null
        };
        
        if (mockDanmaku.isSongRequest) {
          const match = randomComment.match(/ç‚¹æ­Œ\s+(.+?)\s*[-â€“â€”]\s*(.+)/);
          if (match) {
            mockDanmaku.parsedSong = {
              title: match[1].trim(),
              artist: match[2].trim()
            };
          }
        }
        
        displayDanmaku(mockDanmaku);
      }, 3000);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
